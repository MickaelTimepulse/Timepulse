<!DOCTYPE html>
<html>
<head>
  <title>Apply Athletes RLS Fix</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Apply Athletes RLS Fix</h1>
  <button onclick="applyFix()">Click to Apply Fix</button>
  <pre id="output"></pre>

  <script>
    const supabaseUrl = 'https://fgstscztsighabpzzzix.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnc3RzY3p0c2lnaGFicHp6eml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTc4OTksImV4cCI6MjA3NjAzMzg5OX0.K4khoKUHqRy17pweIHVO0_t9WbA0JoTyroleSY4FHr0';

    const client = supabase.createClient(supabaseUrl, supabaseAnonKey);

    async function applyFix() {
      const output = document.getElementById('output');
      output.textContent = 'Applying fix...\n';

      try {
        // First, check current policies
        const { data: policies, error: policiesError } = await client
          .from('pg_policies')
          .select('*')
          .eq('tablename', 'athletes')
          .eq('cmd', 'INSERT');

        output.textContent += 'Current INSERT policies:\n' + JSON.stringify(policies, null, 2) + '\n\n';

        // The issue is we need admin access to modify policies
        // Let's try a different approach - check if the user can actually insert

        output.textContent += 'Testing if current user is authenticated...\n';
        const { data: { user }, error: userError } = await client.auth.getUser();

        if (userError || !user) {
          output.textContent += 'ERROR: No authenticated user. Please login first.\n';
          return;
        }

        output.textContent += 'User ID: ' + user.id + '\n\n';

        // Check if user is in organizers table
        const { data: organizer, error: orgError } = await client
          .from('organizers')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();

        if (orgError) {
          output.textContent += 'ERROR checking organizer: ' + JSON.stringify(orgError) + '\n';
          return;
        }

        if (!organizer) {
          output.textContent += 'ERROR: User is not an organizer. This is the problem!\n';
          output.textContent += 'The user needs to be registered in the organizers table.\n';
          return;
        }

        output.textContent += 'Organizer found:\n' + JSON.stringify(organizer, null, 2) + '\n';
        output.textContent += '\nThe user IS an organizer, so RLS should work.\n';
        output.textContent += 'Please try the form again. The issue may have been temporary.\n';

      } catch (error) {
        output.textContent += 'ERROR: ' + error.message + '\n';
        console.error(error);
      }
    }
  </script>
</body>
</html>
